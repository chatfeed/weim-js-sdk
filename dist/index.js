function t(e,n){return t=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},t(e,n)}var e,n=function(){function t(){this.events=void 0,this.events={}}var e=t.prototype;return e.emit=function(t,e){this.events[t]&&this.events[t].forEach(function(t){return t(e)})},e.on=function(t,e){return this.events[t]?this.events[t].push(e):this.events[t]=[e],this},e.off=function(t,e){if(t&&"function"==typeof e){var n=this.events[t],o=n.findIndex(function(t){return t===e});n.splice(o,1)}else this.events[t]=[]},t}();exports.IMCommand=void 0,(e=exports.IMCommand||(exports.IMCommand={})).LOGIN="Login",e.LOGOUT="Logout",e.GETLOGINSTATUS="GetLoginStatus",exports.IMEvents=void 0,exports.IMEvents||(exports.IMEvents={});var o=function(t){try{t&&t.terminate()}catch(t){console.log(t)}},r=function(){return(36*Math.random()).toString(36).slice(2)+(new Date).getTime().toString()};exports.WEIMSDK=function(e){var n,s;function i(t){var n;return(n=e.call(this)||this).ws=void 0,n.wsUrl="",n.lastTime=0,n.heartbeatCount=0,n.heartbeatStartTime=0,n.logoutFlag=!1,n.lock=!1,n.domain="",n.mid=0,n.platform="wx",n.onceFlag=!0,n.timer=void 0,n.worker=null,n.userInfo=void 0,n.getLoginStatus=function(){return new Promise(function(t,e){r();var o=n.createMsg(exports.IMCommand.GETLOGINSTATUS,n.userInfo,n.userInfo.id,0);n.wsSend(o,t,e)})},n.wsSend=function(t,e,o){var r,s;if((null==(r=n.ws)?void 0:r.readyState)===(null==(s=n.ws)?void 0:s.OPEN)){"object"==typeof t.data&&(t.data=JSON.stringify(t.data));var i=function(e){n.lastTime=(new Date).getTime();var o=JSON.parse(e.data);exports.IMEvents[o.event.toUpperCase()]?n.emit(o.event,o):t.cmd===exports.IMCommand.LOGOUT&&(n.ws.close(),n.ws=void 0,n.onceFlag=!0)};try{"web"==n.platform?(n.ws.send(JSON.stringify(t)),n.ws.onmessage=i):(n.ws.send({data:JSON.stringify(t),success:function(t){"uni"===n.platform&&void 0!==n.ws._callbacks&&void 0!==n.ws._callbacks.message&&(n.ws._callbacks.message=[])}}),n.onceFlag&&(n.ws.onMessage(i),n.onceFlag=!1))}catch(t){return void o({errCode:112,errMsg:"no ws connect..."})}t.cmd===exports.IMCommand.LOGOUT&&(n.onceFlag=!0)}else o({errCode:112,errMsg:"ws conecting"})},n.wsUrl=t.wsUrl,n.domain=t.domain,n.mid=t.mid,n.platform=t.platform,n.userInfo=t.userInfo,n}s=e,(n=i).prototype=Object.create(s.prototype),n.prototype.constructor=n,t(n,s);var a=i.prototype;return a.connect=function(){var t=this;return new Promise(function(e,n){var o=function(){t.iLogin(t.userInfo).then(function(n){t.logoutFlag=!1,t.heartbeat(),e(n)}).catch(function(t){n(t)})},r=function(){n({errCode:111,errMsg:"ws connect close ..."})},s=function(t){n({errCode:112,errMsg:"ws connect error..."})};if("web"===t.platform)return t.ws=new WebSocket(t.wsUrl),t.ws.onclose=r,t.ws.onopen=o,void(t.ws.onerror=s);var i="uni"===t.platform?uni:wx;t.ws=i.connectSocket({url:t.wsUrl,complete:function(){}}),t.ws.onClose(r),t.ws.onOpen(o),t.ws.onError(s),t.ws||n({errCode:112,errMsg:"The current platform is not supported"})})},a.heartbeat=function(){var t,e,n,r,s,i,a,c,u=this;if(console.log("start heartbeat ..."),this.clearTimer(),(null==(t=this.ws)?void 0:t.readyState)===(null==(e=this.ws)?void 0:e.CONNECTING)||(null==(n=this.ws)?void 0:n.readyState)===(null==(r=this.ws)?void 0:r.OPEN)){if(!((new Date).getTime()-this.lastTime<9e3)){this.getLoginStatus().catch(function(t){return u.reconnect()}),this.worker&&o(this.worker);try{this.worker=(s=function(){u.logoutFlag&&u.worker&&o(u.worker)},i=new Blob(["(function (e) {\n        setInterval(function () {\n          this.postMessage(null)\n        }, 10000)\n      })()"]),a=window.URL.createObjectURL(i),(c=new Worker(a)).onmessage=s,c)}catch(t){}}}else this.reconnect()},a.clearTimer=function(){this.timer&&clearTimeout(this.timer)},a.createMsg=function(t,e,n,o){return{cmd:t,domain:this.domain,mid:this.mid,fromId:n,toId:o,data:e}},a.logout=function(t){var e=this;return new Promise(function(n,o){r();var s=e.createMsg(exports.IMCommand.LOGOUT,"",t,0);e.wsSend(s,n,o)})},a.iLogin=function(t){var e=this;return new Promise(function(n,o){var r;null==(r=e.ws)||r.close(),e.ws=void 0,e.wsSend(e.createMsg(exports.IMCommand.LOGIN,t,t.id,0),n,o)})},a.reconnect=function(){var t=this;this.onceFlag||(this.onceFlag=!0),this.lock||(this.lock=!0,this.clearTimer(),this.timer=setTimeout(function(){t.connect(),t.lock=!1},500))},i}(n);
//# sourceMappingURL=index.js.map
