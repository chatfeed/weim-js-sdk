function t(e,n){return t=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},t(e,n)}var e,n,o=function(){function t(){this.events=void 0,this.events={}}var e=t.prototype;return e.emit=function(t,e){this.events[t]&&this.events[t].forEach(function(t){return t(e)})},e.on=function(t,e){return this.events[t]?this.events[t].push(e):this.events[t]=[e],this},e.off=function(t,e){if(t&&"function"==typeof e){var n=this.events[t],o=n.findIndex(function(t){return t===e});n.splice(o,1)}else this.events[t]=[]},t}();!function(t){t.LOGIN="Login",t.LOGOUT="Logout",t.GETLOGINSTATUS="GetLoginStatus"}(e||(e={})),n||(n={});var r=function(t){try{t&&t.terminate()}catch(t){console.log(t)}},i=function(){return(36*Math.random()).toString(36).slice(2)+(new Date).getTime().toString()},s=function(o){var s,c;function a(t){var r;return(r=o.call(this)||this).ws=void 0,r.wsUrl="",r.lastTime=0,r.heartbeatCount=0,r.heartbeatStartTime=0,r.logoutFlag=!1,r.lock=!1,r.domain="",r.mid=0,r.platform="wx",r.onceFlag=!0,r.timer=void 0,r.worker=null,r.userInfo=void 0,r.getLoginStatus=function(){return new Promise(function(t,n){i();var o=r.createMsg(e.GETLOGINSTATUS,r.userInfo,r.userInfo.id,0);r.wsSend(o,t,n)})},r.wsSend=function(t,o,i){var s,c;if((null==(s=r.ws)?void 0:s.readyState)===(null==(c=r.ws)?void 0:c.OPEN)){"object"==typeof t.data&&(t.data=JSON.stringify(t.data));var a=function(o){r.lastTime=(new Date).getTime();var i=JSON.parse(o.data);n[i.event.toUpperCase()]?r.emit(i.event,i):t.cmd===e.LOGOUT&&(r.ws.close(),r.ws=void 0,r.onceFlag=!0)};try{"web"==r.platform?(r.ws.send(JSON.stringify(t)),r.ws.onmessage=a):(r.ws.send({data:JSON.stringify(t),success:function(t){"uni"===r.platform&&void 0!==r.ws._callbacks&&void 0!==r.ws._callbacks.message&&(r.ws._callbacks.message=[])}}),r.onceFlag&&(r.ws.onMessage(a),r.onceFlag=!1))}catch(t){return void i({errCode:112,errMsg:"no ws connect..."})}t.cmd===e.LOGOUT&&(r.onceFlag=!0)}else i({errCode:112,errMsg:"ws conecting"})},r.wsUrl=t.wsUrl,r.domain=t.domain,r.mid=t.mid,r.platform=t.platform,r.userInfo=t.userInfo,r}c=o,(s=a).prototype=Object.create(c.prototype),s.prototype.constructor=s,t(s,c);var u=a.prototype;return u.connect=function(){var t=this;return new Promise(function(e,n){var o=function(){t.iLogin(t.userInfo).then(function(n){t.logoutFlag=!1,t.heartbeat(),e(n)}).catch(function(t){n(t)})},r=function(){n({errCode:111,errMsg:"ws connect close ..."})},i=function(t){n({errCode:112,errMsg:"ws connect error..."})};if("web"===t.platform)return t.ws=new WebSocket(t.wsUrl),t.ws.onclose=r,t.ws.onopen=o,void(t.ws.onerror=i);var s="uni"===t.platform?uni:wx;t.ws=s.connectSocket({url:t.wsUrl,complete:function(){}}),t.ws.onClose(r),t.ws.onOpen(o),t.ws.onError(i),t.ws||n({errCode:112,errMsg:"The current platform is not supported"})})},u.heartbeat=function(){var t,e,n,o,i,s,c,a,u=this;if(console.log("start heartbeat ..."),this.clearTimer(),(null==(t=this.ws)?void 0:t.readyState)===(null==(e=this.ws)?void 0:e.CONNECTING)||(null==(n=this.ws)?void 0:n.readyState)===(null==(o=this.ws)?void 0:o.OPEN)){if(!((new Date).getTime()-this.lastTime<9e3)){this.getLoginStatus().catch(function(t){return u.reconnect()}),this.worker&&r(this.worker);try{this.worker=(i=function(){u.logoutFlag&&u.worker&&r(u.worker)},s=new Blob(["(function (e) {\n        setInterval(function () {\n          this.postMessage(null)\n        }, 10000)\n      })()"]),c=window.URL.createObjectURL(s),(a=new Worker(c)).onmessage=i,a)}catch(t){}}}else this.reconnect()},u.clearTimer=function(){this.timer&&clearTimeout(this.timer)},u.createMsg=function(t,e,n,o){return{cmd:t,domain:this.domain,mid:this.mid,fromId:n,toId:o,data:e}},u.logout=function(t){var n=this;return new Promise(function(o,r){i();var s=n.createMsg(e.LOGOUT,"",t,0);n.wsSend(s,o,r)})},u.iLogin=function(t){var n=this;return new Promise(function(o,r){var i;null==(i=n.ws)||i.close(),n.ws=void 0,n.wsSend(n.createMsg(e.LOGIN,t,t.id,0),o,r)})},u.reconnect=function(){var t=this;this.onceFlag||(this.onceFlag=!0),this.lock||(this.lock=!0,this.clearTimer(),this.timer=setTimeout(function(){t.connect(),t.lock=!1},500))},a}(o);export{e as IMCommand,n as IMEvents,s as WEIMSDK};
//# sourceMappingURL=index.esm.js.map
