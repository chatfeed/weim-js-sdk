!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t||self).weimJsSdk={})}(this,function(t){function e(t,n){return e=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},e(t,n)}var n,o=function(){function t(){this.events=void 0,this.events={}}var e=t.prototype;return e.emit=function(t,e){this.events[t]&&this.events[t].forEach(function(t){return t(e)})},e.on=function(t,e){return this.events[t]?this.events[t].push(e):this.events[t]=[e],this},e.off=function(t,e){if(t&&"function"==typeof e){var n=this.events[t],o=n.findIndex(function(t){return t===e});n.splice(o,1)}else this.events[t]=[]},t}();t.IMCommand=void 0,(n=t.IMCommand||(t.IMCommand={})).LOGIN="Login",n.LOGOUT="Logout",n.GETLOGINSTATUS="GetLoginStatus",t.IMEvents=void 0,t.IMEvents||(t.IMEvents={});var r=function(t){try{t&&t.terminate()}catch(t){console.log(t)}},i=function(){return(36*Math.random()).toString(36).slice(2)+(new Date).getTime().toString()};t.WEIMSDK=function(n){var o,s;function a(e){var o;return(o=n.call(this)||this).ws=void 0,o.wsUrl="",o.lastTime=0,o.heartbeatCount=0,o.heartbeatStartTime=0,o.logoutFlag=!1,o.lock=!1,o.domain="",o.mid=0,o.platform="wx",o.onceFlag=!0,o.timer=void 0,o.worker=null,o.userInfo=void 0,o.getLoginStatus=function(){return new Promise(function(e,n){i();var r=o.createMsg(t.IMCommand.GETLOGINSTATUS,o.userInfo,o.userInfo.id,0);o.wsSend(r,e,n)})},o.wsSend=function(e,n,r){var i,s;if((null==(i=o.ws)?void 0:i.readyState)===(null==(s=o.ws)?void 0:s.OPEN)){"object"==typeof e.data&&(e.data=JSON.stringify(e.data));var a=function(n){o.lastTime=(new Date).getTime();var r=JSON.parse(n.data);t.IMEvents[r.event.toUpperCase()]?o.emit(r.event,r):e.cmd===t.IMCommand.LOGOUT&&(o.ws.close(),o.ws=void 0,o.onceFlag=!0)};try{"web"==o.platform?(o.ws.send(JSON.stringify(e)),o.ws.onmessage=a):(o.ws.send({data:JSON.stringify(e),success:function(t){"uni"===o.platform&&void 0!==o.ws._callbacks&&void 0!==o.ws._callbacks.message&&(o.ws._callbacks.message=[])}}),o.onceFlag&&(o.ws.onMessage(a),o.onceFlag=!1))}catch(t){return void r({errCode:112,errMsg:"no ws connect..."})}e.cmd===t.IMCommand.LOGOUT&&(o.onceFlag=!0)}else r({errCode:112,errMsg:"ws conecting"})},o.wsUrl=e.wsUrl,o.domain=e.domain,o.mid=e.mid,o.platform=e.platform,o.userInfo=e.userInfo,o}s=n,(o=a).prototype=Object.create(s.prototype),o.prototype.constructor=o,e(o,s);var c=a.prototype;return c.connect=function(){var t=this;return new Promise(function(e,n){var o=function(){t.iLogin(t.userInfo).then(function(n){t.logoutFlag=!1,t.heartbeat(),e(n)}).catch(function(t){n(t)})},r=function(){n({errCode:111,errMsg:"ws connect close ..."})},i=function(t){n({errCode:112,errMsg:"ws connect error..."})};if("web"===t.platform)return t.ws=new WebSocket(t.wsUrl),t.ws.onclose=r,t.ws.onopen=o,void(t.ws.onerror=i);var s="uni"===t.platform?uni:wx;t.ws=s.connectSocket({url:t.wsUrl,complete:function(){}}),t.ws.onClose(r),t.ws.onOpen(o),t.ws.onError(i),t.ws||n({errCode:112,errMsg:"The current platform is not supported"})})},c.heartbeat=function(){var t,e,n,o,i,s,a,c,u=this;if(console.log("start heartbeat ..."),this.clearTimer(),(null==(t=this.ws)?void 0:t.readyState)===(null==(e=this.ws)?void 0:e.CONNECTING)||(null==(n=this.ws)?void 0:n.readyState)===(null==(o=this.ws)?void 0:o.OPEN)){if(!((new Date).getTime()-this.lastTime<9e3)){this.getLoginStatus().catch(function(t){return u.reconnect()}),this.worker&&r(this.worker);try{this.worker=(i=function(){u.logoutFlag&&u.worker&&r(u.worker)},s=new Blob(["(function (e) {\n        setInterval(function () {\n          this.postMessage(null)\n        }, 10000)\n      })()"]),a=window.URL.createObjectURL(s),(c=new Worker(a)).onmessage=i,c)}catch(t){}}}else this.reconnect()},c.clearTimer=function(){this.timer&&clearTimeout(this.timer)},c.createMsg=function(t,e,n,o){return{cmd:t,domain:this.domain,mid:this.mid,fromId:n,toId:o,data:e}},c.logout=function(e){var n=this;return new Promise(function(o,r){i();var s=n.createMsg(t.IMCommand.LOGOUT,"",e,0);n.wsSend(s,o,r)})},c.iLogin=function(e){var n=this;return new Promise(function(o,r){var i;null==(i=n.ws)||i.close(),n.ws=void 0,n.wsSend(n.createMsg(t.IMCommand.LOGIN,e,e.id,0),o,r)})},c.reconnect=function(){var t=this;this.onceFlag||(this.onceFlag=!0),this.lock||(this.lock=!0,this.clearTimer(),this.timer=setTimeout(function(){t.connect(),t.lock=!1},500))},a}(o)});
//# sourceMappingURL=index.umd.js.map
