var t,s;!function(t){t.LOGIN="Login",t.LOGOUT="Logout",t.GETLOGINSTATUS="GetLoginStatus"}(t||(t={})),s||(s={});const e=t=>{try{t&&t.terminate()}catch(t){console.log(t)}},i=()=>(36*Math.random()).toString(36).slice(2)+(new Date).getTime().toString();class o extends class{constructor(){this.events=void 0,this.events={}}emit(t,s){this.events[t]&&this.events[t].forEach(t=>t(s))}on(t,s){return this.events[t]?this.events[t].push(s):this.events[t]=[s],this}off(t,s){if(t&&"function"==typeof s){const e=this.events[t],i=e.findIndex(t=>t===s);e.splice(i,1)}else this.events[t]=[]}}{constructor(e){super(),this.ws=void 0,this.wsUrl="",this.lastTime=0,this.heartbeatCount=0,this.heartbeatStartTime=0,this.logoutFlag=!1,this.lock=!1,this.domain="",this.mid=0,this.platform="wx",this.onceFlag=!0,this.timer=void 0,this.worker=null,this.userInfo=void 0,this.getLoginStatus=()=>new Promise((s,e)=>{i();const o=this.createMsg(t.GETLOGINSTATUS,this.userInfo,this.userInfo.id,0);this.wsSend(o,s,e)}),this.wsSend=(e,i,o)=>{var n,r;if((null==(n=this.ws)?void 0:n.readyState)!==(null==(r=this.ws)?void 0:r.OPEN))return void o({errCode:112,errMsg:"ws conecting"});"object"==typeof e.data&&(e.data=JSON.stringify(e.data));const h=i=>{this.lastTime=(new Date).getTime();const o=JSON.parse(i.data);s[o.event.toUpperCase()]?this.emit(o.event,o):e.cmd===t.LOGOUT&&(this.ws.close(),this.ws=void 0,this.onceFlag=!0)};try{"web"==this.platform?(this.ws.send(JSON.stringify(e)),this.ws.onmessage=h):(this.ws.send({data:JSON.stringify(e),success:t=>{"uni"===this.platform&&void 0!==this.ws._callbacks&&void 0!==this.ws._callbacks.message&&(this.ws._callbacks.message=[])}}),this.onceFlag&&(this.ws.onMessage(h),this.onceFlag=!1))}catch(t){return void o({errCode:112,errMsg:"no ws connect..."})}e.cmd===t.LOGOUT&&(this.onceFlag=!0)},this.wsUrl=e.wsUrl,this.domain=e.domain,this.mid=e.mid,this.platform=e.platform,this.userInfo=e.userInfo}connect(){return new Promise((t,s)=>{const e=()=>{this.iLogin(this.userInfo).then(s=>{this.logoutFlag=!1,this.heartbeat(),t(s)}).catch(t=>{s(t)})},i=()=>{s({errCode:111,errMsg:"ws connect close ..."})},o=t=>{s({errCode:112,errMsg:"ws connect error..."})};if("web"===this.platform)return this.ws=new WebSocket(this.wsUrl),this.ws.onclose=i,this.ws.onopen=e,void(this.ws.onerror=o);const n="uni"===this.platform?uni:wx;this.ws=n.connectSocket({url:this.wsUrl,complete:()=>{}}),this.ws.onClose(i),this.ws.onOpen(e),this.ws.onError(o),this.ws||s({errCode:112,errMsg:"The current platform is not supported"})})}heartbeat(){var t,s,i,o;console.log("start heartbeat ..."),this.clearTimer();const n=()=>{this.logoutFlag&&this.worker&&e(this.worker)};if((null==(t=this.ws)?void 0:t.readyState)===(null==(s=this.ws)?void 0:s.CONNECTING)||(null==(i=this.ws)?void 0:i.readyState)===(null==(o=this.ws)?void 0:o.OPEN)){if(!((new Date).getTime()-this.lastTime<9e3)){this.getLoginStatus().catch(t=>this.reconnect()),this.worker&&e(this.worker);try{this.worker=((t,s)=>{const e=function(t){const s=new Blob(["(function (e) {\n        setInterval(function () {\n          this.postMessage(null)\n        }, 10000)\n      })()"]),e=window.URL.createObjectURL(s);return new Worker(e)}();return e.onmessage=t,e})(n)}catch(t){}}}else this.reconnect()}clearTimer(){this.timer&&clearTimeout(this.timer)}createMsg(t,s,e,i){return{cmd:t,domain:this.domain,mid:this.mid,fromId:e,toId:i,data:s}}logout(s){return new Promise((e,o)=>{i();const n=this.createMsg(t.LOGOUT,"",s,0);this.wsSend(n,e,o)})}iLogin(s){return new Promise((e,i)=>{var o;null==(o=this.ws)||o.close(),this.ws=void 0,this.wsSend(this.createMsg(t.LOGIN,s,s.id,0),e,i)})}reconnect(){this.onceFlag||(this.onceFlag=!0),this.lock||(this.lock=!0,this.clearTimer(),this.timer=setTimeout(()=>{this.connect(),this.lock=!1},500))}}export{t as IMCommand,s as IMEvents,o as WEIMSDK};
//# sourceMappingURL=index.modern.js.map
