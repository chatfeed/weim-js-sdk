{"code":"import { Emitter } from \"./emitter\";\r\nimport { IMCommand, IMEvents } from \"./constants\";\r\nimport { createWorker, stopWorker, uuid } from \"./utils\";\r\nexport default class WEIMSDK extends Emitter {\r\n    ws;\r\n    wsUrl = \"\";\r\n    lastTime = 0;\r\n    heartbeatCount = 0;\r\n    heartbeatStartTime = 0;\r\n    logoutFlag = false;\r\n    lock = false;\r\n    domain = \"\";\r\n    mid = 0;\r\n    platform = \"wx\";\r\n    onceFlag = true;\r\n    timer = undefined;\r\n    worker = null;\r\n    userInfo;\r\n    constructor(cfg) {\r\n        super();\r\n        this.wsUrl = cfg.wsUrl;\r\n        this.domain = cfg.domain;\r\n        this.mid = cfg.mid;\r\n        this.platform = cfg.platform;\r\n        this.userInfo = cfg.userInfo;\r\n    }\r\n    connect() {\r\n        return new Promise((resolve, reject) => {\r\n            const onOpen = () => {\r\n                this.iLogin(this.userInfo).then((res) => {\r\n                    this.logoutFlag = false;\r\n                    this.heartbeat();\r\n                    resolve(res);\r\n                })\r\n                    .catch((err) => {\r\n                    reject(err);\r\n                });\r\n            };\r\n            const onClose = () => {\r\n                if (!this.logoutFlag) {\r\n                    // Object.values()\r\n                }\r\n                reject({ errCode: 111, errMsg: 'ws connect close ...' });\r\n            };\r\n            const onError = (err) => {\r\n                reject({ errCode: 112, errMsg: 'ws connect error...' });\r\n            };\r\n            if (this.platform === 'web') {\r\n                this.ws = new WebSocket(this.wsUrl);\r\n                this.ws.onclose = onClose;\r\n                this.ws.onopen = onOpen;\r\n                this.ws.onerror = onError;\r\n                return;\r\n            }\r\n            //@ts-ignore\r\n            const platformNamespace = this.platform === \"uni\" ? uni : wx;\r\n            this.ws = platformNamespace.connectSocket({\r\n                url: this.wsUrl,\r\n                complete: () => { },\r\n            });\r\n            //@ts-ignore\r\n            this.ws.onClose(onClose);\r\n            //@ts-ignore\r\n            this.ws.onOpen(onOpen);\r\n            //@ts-ignore\r\n            this.ws.onError(onError);\r\n            if (!this.ws) {\r\n                reject({ errCode: 112, errMsg: 'The current platform is not supported' });\r\n            }\r\n        });\r\n    }\r\n    heartbeat() {\r\n        console.log('start heartbeat ...');\r\n        this.clearTimer();\r\n        const callback = () => {\r\n            if (this.logoutFlag) {\r\n                if (this.worker) {\r\n                    stopWorker(this.worker);\r\n                }\r\n            }\r\n        };\r\n        if (this.ws?.readyState !== this.ws?.CONNECTING && this.ws?.readyState !== this.ws?.OPEN) {\r\n            this.reconnect();\r\n            return;\r\n        }\r\n        const now = new Date().getTime();\r\n        if (now - this.lastTime < 9000) {\r\n            return;\r\n        }\r\n        this.getLoginStatus().catch((err) => this.reconnect());\r\n        if (this.worker) {\r\n            stopWorker(this.worker);\r\n        }\r\n        try {\r\n            this.worker = createWorker(callback, 10000);\r\n        }\r\n        catch (error) {\r\n        }\r\n    }\r\n    clearTimer() {\r\n        if (this.timer) {\r\n            clearTimeout(this.timer);\r\n        }\r\n    }\r\n    createMsg(cmd, data, fromId, toId) {\r\n        return {\r\n            cmd: cmd,\r\n            domain: this.domain,\r\n            mid: this.mid,\r\n            fromId: fromId,\r\n            toId: toId,\r\n            data: data\r\n        };\r\n    }\r\n    logout(uid) {\r\n        return new Promise((resolve, reject) => {\r\n            const _uuid = uuid();\r\n            const msg = this.createMsg(IMCommand.LOGOUT, \"\", uid, 0);\r\n            this.wsSend(msg, resolve, reject);\r\n        });\r\n    }\r\n    getLoginStatus = () => {\r\n        return new Promise((resolve, reject) => {\r\n            const _uuid = uuid();\r\n            const msg = this.createMsg(IMCommand.GETLOGINSTATUS, this.userInfo, this.userInfo.id, 0);\r\n            this.wsSend(msg, resolve, reject);\r\n        });\r\n    };\r\n    iLogin(data) {\r\n        return new Promise((resolve, reject) => {\r\n            this.ws?.close();\r\n            this.ws = undefined;\r\n            this.wsSend(this.createMsg(IMCommand.LOGIN, data, data.id, 0), resolve, reject);\r\n        });\r\n    }\r\n    reconnect() {\r\n        if (!this.onceFlag)\r\n            this.onceFlag = true;\r\n        if (this.lock)\r\n            return;\r\n        this.lock = true;\r\n        this.clearTimer();\r\n        this.timer = setTimeout(() => {\r\n            this.connect();\r\n            this.lock = false;\r\n        }, 500);\r\n    }\r\n    wsSend = (msg, resolve, reject) => {\r\n        if (this.ws?.readyState !== this.ws?.OPEN) {\r\n            reject({ errCode: 112, errMsg: 'ws conecting' });\r\n            return;\r\n        }\r\n        if (typeof msg.data === \"object\") {\r\n            msg.data = JSON.stringify(msg.data);\r\n        }\r\n        const handleMessage = (ev) => {\r\n            this.lastTime = new Date().getTime();\r\n            const data = JSON.parse(ev.data);\r\n            if (IMEvents[data.event.toUpperCase()]) {\r\n                this.emit(data.event, data);\r\n                return;\r\n            }\r\n            if (msg.cmd === IMCommand.LOGOUT) {\r\n                //退出指令\r\n                this.ws.close();\r\n                this.ws = undefined;\r\n                this.onceFlag = true;\r\n            }\r\n            // const callbackJob = this.ws2promise()\r\n        };\r\n        try {\r\n            if (this.platform == 'web') {\r\n                this.ws.send(JSON.stringify(msg));\r\n                this.ws.onmessage = handleMessage;\r\n            }\r\n            else {\r\n                this.ws.send({\r\n                    //@ts-ignore\r\n                    data: JSON.stringify(msg),\r\n                    success: (res) => {\r\n                        if (this.platform === 'uni' &&\r\n                            //@ts-ignore\r\n                            this.ws._callbacks !== undefined &&\r\n                            //@ts-ignore\r\n                            this.ws._callbacks.message !== undefined) {\r\n                            //@ts-ignore\r\n                            this.ws._callbacks.message = [];\r\n                        }\r\n                    }\r\n                });\r\n                if (this.onceFlag) {\r\n                    //@ts-ignore\r\n                    this.ws.onMessage(handleMessage);\r\n                    this.onceFlag = false;\r\n                }\r\n            }\r\n        }\r\n        catch (error) {\r\n            reject({ errCode: 112, errMsg: \"no ws connect...\" });\r\n            return;\r\n        }\r\n        if (msg.cmd === IMCommand.LOGOUT) {\r\n            this.onceFlag = true;\r\n        }\r\n    };\r\n}\r\n//# sourceMappingURL=weim.js.map","references":["/Users/chatfeed/projects/golang/weim-js-sdk/src/emitter.ts","/Users/chatfeed/projects/golang/weim-js-sdk/src/types/index.d.ts","/Users/chatfeed/projects/golang/weim-js-sdk/src/constants/index.ts","/Users/chatfeed/projects/golang/weim-js-sdk/src/utils/index.ts"],"map":"{\"version\":3,\"file\":\"weim.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../src/weim.ts\"],\"names\":[],\"mappings\":\"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\"}","dts":{"name":"/Users/chatfeed/projects/golang/weim-js-sdk/dist/weim.d.ts","writeByteOrderMark":false,"text":"import { Emitter } from \"./emitter\";\r\nimport { WebsocketResponse, InitConfig } from \"./types\";\r\nexport default class WEIMSDK extends Emitter {\r\n    private ws;\r\n    private wsUrl;\r\n    private lastTime;\r\n    private heartbeatCount;\r\n    private heartbeatStartTime;\r\n    private logoutFlag;\r\n    private lock;\r\n    private domain;\r\n    private mid;\r\n    private platform;\r\n    private onceFlag;\r\n    private timer;\r\n    private worker;\r\n    private userInfo;\r\n    constructor(cfg: InitConfig);\r\n    connect(): Promise<WebsocketResponse>;\r\n    private heartbeat;\r\n    private clearTimer;\r\n    private createMsg;\r\n    logout(uid: Number): Promise<WebsocketResponse>;\r\n    getLoginStatus: () => Promise<WebsocketResponse>;\r\n    private iLogin;\r\n    private reconnect;\r\n    private wsSend;\r\n}\r\n"}}
